<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebCL - create two contexts to test two kernels using the same device.</title>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/kernels.js"></script>
<script src="../resources/webcl-test-utils.js"></script>

<script>

var DATA_SIZE = 1024;

var data;

var cl;
var platforms;
var platform;
var devices;

var contextSum;
var queueSum;
var programSum;
var kernelSum;
var inputSum_A;
var inputSum_B;
var outputSum;

var contextMult;
var queueMult;
var programMult;
var kernelMult;
var inputMult_A;
var inputMult_B;
var outputMult;


var globalWorkSize = new Int32Array(1);
var localWorkSize = new Int32Array(1);
var results = new Int32Array(DATA_SIZE);

function runTest() {

    // Generate a random vector with random values between 1 - 100
    var randomVector = WebCLTestUtils.getRandomVector(DATA_SIZE, 100);
    data = new Int32Array(randomVector);

    try {

        if (webcl === "undefined") {
            testFailed("webcl is yet to be undefined");
            return null;
        }

        cl = webcl;

        if (cl === null) {
            testFailed("Failed to create webcl object");
            return;
        }

        platforms = cl.getPlatforms();
        if (platforms.length === 0) {
            testFailed("No platforms available");
            return;
        }
        platform = platforms[0];
        devices = platform.getDevices();
        numDevices = devices.length;
        if (numDevices === 0) {
            testFailed("No devices available");
            return;
        }

        var contextProperties = {platform: platform, devices: devices, deviceType: cl.DEVICE_TYPE_DEFAULT};
        contextSum = cl.createContext(contextProperties);
        contextMult = cl.createContext(contextProperties);
        if (!contextSum || !contextMult) {
            testFailed("It was not possible to create WebCLContexts.");
            return;
        }

        queueSum = contextSum.createCommandQueue(devices[0], null);
        queueMult = contextMult.createCommandQueue(devices[0], null);

        var kernelSourceSum = Kernels.vector_add;
        var kernelSourceMult = Kernels.vector_mult;

        programSum = contextSum.createProgram(kernelSourceSum);
        programMult = contextMult.createProgram(kernelSourceMult);

        programSum.build(devices);
        programMult.build(devices);

        kernelSum = programSum.createKernel("vector_add");
        kernelMult = programMult.createKernel("vector_mult");

        inputSum_A = contextSum.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        inputSum_B = contextSum.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        outputSum = contextSum.createBuffer(cl.MEM_WRITE_ONLY, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        if (!inputSum_A || !inputSum_B || !outputSum) {
            testFailed("Failed to alocate buffers for kernel vector_add");
            return;
        }

        inputMult_A = contextMult.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        inputMult_B = contextMult.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        outputMult = contextMult.createBuffer(cl.MEM_WRITE_ONLY, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE);
        if (!inputMult_A || !inputMult_B || !outputMult) {
            testFailed("Failed to alocate buffers for kernel vector_mult");
            return;
        }

        queueMult.enqueueWriteBuffer(inputMult_A, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, data);
        queueMult.enqueueWriteBuffer(inputMult_B, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, data);
        queueSum.enqueueWriteBuffer(inputSum_A, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, data);
        queueSum.enqueueWriteBuffer(inputSum_B, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, data);

        kernelSum.setArg(0, inputSum_A);
        kernelSum.setArg(1, inputSum_B);
        kernelSum.setArg(2, outputSum);
        kernelSum.setArg(3, new Uint32Array([DATA_SIZE]));

        kernelMult.setArg(0, inputMult_A);
        kernelMult.setArg(1, inputMult_B);
        kernelMult.setArg(2, outputMult);
        kernelMult.setArg(3, new Uint32Array([DATA_SIZE]));

        globalWorkSize[0] = DATA_SIZE;

        var workGroupSize = kernelSum.getWorkGroupInfo(devices[0], cl.KERNEL_WORK_GROUP_SIZE);
        localWorkSize[0] = workGroupSize;
        queueSum.enqueueNDRangeKernel(kernelSum, 0, globalWorkSize, localWorkSize);
        queueSum.finish();
        queueSum.enqueueReadBuffer(outputSum, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, results);
        for (i = 0; i < DATA_SIZE; i++) {
            if (results[i] !== (data[i] + data[i])) {
                testFailed("Test has failed for kernel: " + kernelSum.getInfo(cl.KERNEL_FUNCTION_NAME));
                break;
            }
        }

        workGroupSize = kernelMult.getWorkGroupInfo(devices[0], cl.KERNEL_WORK_GROUP_SIZE);
        localWorkSize[0] = workGroupSize;
        queueMult.enqueueNDRangeKernel(kernelMult, 0, globalWorkSize, localWorkSize);
        queueMult.finish();
        queueMult.enqueueReadBuffer(outputMult, true, 0, Int32Array.BYTES_PER_ELEMENT * DATA_SIZE, results);
        for (i = 0; i < DATA_SIZE; i++) {
            if (results[i] !== (data[i] * data[i])) {
                testFailed("Test has failed for kernel: " + kernelSum.getInfo(cl.KERNEL_FUNCTION_NAME));
                break;
            }
        }

        testPassed("");
    } catch (e) {
        testFailed("WebCL Test: a device using multiples context has failed. Message: " + e.message);
    }
}
</script>

</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Test two contexts with different kernels in a same device");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
