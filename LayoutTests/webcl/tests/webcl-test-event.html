<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebCLEvent test </title>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/kernels.js"></script>
<script src="../resources/logger.js"></script>
<script src="../resources/webcl-proxy.js"></script>

<script>

function runTest() {

    var clCallback = function eventCallback() {
        alert("WebCLEventCallback!!");
    };

	var globalWorkSize = new Int32Array(1);
	var localWorkSize  = new Int32Array(1);
	var results        = new Uint32Array(1);
	var events = [];

    try {

        /* Get WebCLProxy */
        var proxy = WebCLProxy;

        /* Test WebCLProxy */
        if (!proxy) {
            testFailed("WebCLProxy object is not defined ...");
            return;
        }

        /* Get wcl objects */
        var platform = proxy.getWCLPlatform();
        var device =   platform.getWCLDevice();
        var context =  platform.createWCLContext();
        var queue =    context.createWCLCommandQueue(device, null);

        var kernelSource = Kernels.kernel_item;
        if (kernelSource === null) {
            testFailed("No kernel named: " + "kernel_item");
            return;
        }

        var program = context.createWCLProgram(kernelSource);
        program.build();

        var kernel = program.createWCLKernel("kernel_item");
        // Get the maximum work group size for executing the kernel on the device
        var workGroupSize = kernel.getWorkGroupInfo(device, proxy.KERNEL_WORK_GROUP_SIZE);

        //Create buffer for output
        var output = context.createWCLBuffer(proxy.MEM_WRITE_ONLY, Uint32Array.BYTES_PER_ELEMENT, null);
        globalWorkSize[0] = 1;
        localWorkSize[0] = 1;

        kernel.setWCLKernelArgs(0, output, null);

        var wclEvent = context.createWCLUserEvent();
        wclEvent.setCallback(proxy.STOPPED, clCallback);

        var ndRangeDict = {};
        ndRangeDict.kernel = kernel;
        ndRangeDict.globalWorkOffset = new Int32Array(0);
        ndRangeDict.globalWorkSize = globalWorkSize;
        ndRangeDict.localWorkSize = localWorkSize;
        ndRangeDict.globalWorkOffset[0] = 0;
        ndRangeDict.eventWaitList = [wclEvent];
        queue.enqueueNDRangeKernel(ndRangeDict);

        queue.finish();

    } catch (e) {
        testFailed("WebCLEvent test failed ; Message: " + e.message);
    }
}

</script>
</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Just testing if a WebCLEvent is working properly...");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
