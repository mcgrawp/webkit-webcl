<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebCL all devices test.</title>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/kernels.js"></script>
<script src="../resources/webcl-test-utils.js"></script>

<script>
var DATA_SIZE = 1024;

var data;
var results = new Int32Array(DATA_SIZE);
var count;

var cl;
var platforms;
var platform;
var devices;
var numDevices;
var context;
var queues;
var program;
var kernel;

var input;
var output;

var globalWorkSize = new Int32Array(1);
var localWorkSize = new Int32Array(1);

function runTest() {

    count = DATA_SIZE;
    // Generate a random vector with random values between 1 - 100
    var randomVector = WebCLTestUtils.getRandomVector(count, 100);
    data = new Int32Array(randomVector);

    try {

        if (webcl === "undefined") {
            testFailed("webcl is yet to be undefined");
            return null;
        }

        cl = webcl;

        if (cl === null) {
            testFailed("Failed to create webcl object");
            return;
        }

        platforms = cl.getPlatforms();
        if (platforms.length === 0) {
            testFailed("No platforms available");
            return;
        }
        platform = platforms[0];
        devices = platform.getDevices(cl.DEVICE_TYPE_ALL);
        numDevices = devices.length;
        if (numDevices === 0) {
            testFailed("No devices available");
            return;
        }

        var contextProperties = {platform: platform, devices: devices, deviceType: cl.DEVICE_TYPE_ALL};
        context = cl.createContext(contextProperties);

        queues = [numDevices];

        for (i = 0; i < numDevices; i++) {
            queues[i] = context.createCommandQueue(devices[i], null);
        }

        var kernelSource = Kernels.square;
        if (kernelSource === null) {
            testFailed("No kernel named: " + "square");
            return;
        }
        program = context.createProgram(kernelSource);

        program.build(devices);

        kernel = program.createKernel("square");

        input = context.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * count);
        if (input === null) {
            testFailed("Failed to alocate device memory for input data");
            return;
        }

        var outputs = [numDevices];
        for (i = 0; i < numDevices; i++) {
            outputs[i] = context.createBuffer(cl.MEM_WRITE_ONLY, Int32Array.BYTES_PER_ELEMENT * count);
            if (outputs[i] === null) {
                testFailed("Failed to allocate device memory for output data");
                return;
            }
        }

        for (i = 0; i < numDevices; i++) {
            queues[i].enqueueWriteBuffer(input, true, 0, Int32Array.BYTES_PER_ELEMENT * count, data);
        }

        var types = WebCLKernelArgumentTypes;
        kernel.setArg(0, input);
        kernel.setArg(2, count, types.UINT);

        var workGroupSize = [numDevices];
        for (i = 0; i < numDevices; i++) {
            workGroupSize[i] = kernel.getWorkGroupInfo(devices[i], cl.KERNEL_WORK_GROUP_SIZE);
        }

        globalWorkSize[0] = count;

        for (i = 0; i < numDevices; i++) {
            localWorkSize[0] = workGroupSize[i];
            kernel.setArg(1, outputs[i]);
            queues[i].enqueueNDRangeKernel(kernel, null, globalWorkSize, localWorkSize);
        }

        for (i = 0; i < numDevices; i++) {
            queues[i].finish();
        }

        for (i = 0; i < numDevices; i++) {
            queues[i].enqueueReadBuffer(outputs[i], true, 0, Int32Array.BYTES_PER_ELEMENT * count, results);
            for (j = 0; j < count; j++) {
                if (results[j] !== (data[j] * data[j])) {
                    testFailed("Test failed for device: " + devices[i].getInfo(cl.DEVICE_TYPE));
                    break;
                }
            }
        }
        testPassed("");
    } catch (e) {
        testFailed("WebCL: test all devices using a single context has failed. ; Message: " + e.message);
    }
}
</script>

</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Test all devices available in one platform using a single context");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
