<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebCL all devices test.</title>
<link rel="stylesheet" href="../resources/js-test-style.css"/>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/kernels.js"></script>

<script>
var DATA_SIZE = 1024;

var err;

var data = new Int32Array(DATA_SIZE);
var results = new Int32Array(DATA_SIZE);
var count;

var cl;
var platforms;
var platform;
var devices;
var numDevices;
var context;
var queues;
var program;
var kernel;

var input;
var output;

var globalWorkSize = new Int32Array(1);
var localWorkSize = new Int32Array(1);

function runTest()
{
    count = DATA_SIZE;
    for (var i = 0; i < count; i++)
        data[i] = Math.random();

    try {

        if (typeof(webcl) === "undefined") {
            testFailed("webcl is yet to be undefined");
            return null;
        }

        cl = webcl;

        if (cl === null) {
            testFailed("Failed to create webcl object");
            return;
        }

        platforms = cl.getPlatforms();
        if (platforms.length === 0) {
            testFailed("No platforms available");
            return;
        }
        platform = platforms[0];

        devices = platform.getDevices(cl.DEVICE_TYPE_ALL);
        numDevices = devices.length;
        if (numDevices === 0) {
            testFailed("No devices available");
            return;
        }

        var contextProperties = {platform: platform, devices: devices, deviceType: cl.DEVICE_TYPE_ALL, hint: null};
        context = cl.createContext(contextProperties);

        queues = new Array(numDevices);

        for (var i = 0; i < numDevices; i++)
            queues[i] = context.createCommandQueue(devices[i], null);

        var kernelSource = Kernels.square;
        if (kernelSource === null) {
            testFailed("No kernel named: " + "square");
            return;
        }
        program = context.createProgram(kernelSource);

        program.build(devices);

        kernel = program.createKernel("square");

        input = context.createBuffer(cl.MEM_READ_ONLY,  Int32Array.BYTES_PER_ELEMENT * count);
        if (input === null) {
            testFailed("Failed to alocate device memory for input data");
            return;
        }

        outputs = new Array(numDevices);
        for (var i = 0; i < numDevices; i++) {
            outputs[i] = context.createBuffer( cl.MEM_WRITE_ONLY, Int32Array.BYTES_PER_ELEMENT * count);
            if (outputs[i] === null) {
                testFailed("Failed to allocate device memory for output data");
                return;
            }
        }

        for (var i = 0; i < numDevices; i++)
            queues[i].enqueueWriteBuffer( input, true, 0, Int32Array.BYTES_PER_ELEMENT * count, data );

        kernel.setArg(0, input);
        kernel.setArg(1, outputs[0]);
        kernel.setArg(2, count, cl.LONG);

        var workGroupSize = kernel.getWorkGroupInfo(devices[0], cl.KERNEL_WORK_GROUP_SIZE);

        globalWorkSize[0] = count;
        localWorkSize[0] = workGroupSize;

        for (var i = 0; i < numDevices; i++)
            queues[i].enqueueNDRangeKernel( kernel, null, globalWorkSize, localWorkSize);

        for (var i = 0; i < numDevices; i++)
            queues[i].finish();

        for (var i = 0; i < numDevices; i++) {
            queues[i].enqueueReadBuffer(outputs[i], true, 0, Int32Array.BYTES_PER_ELEMENT * count, results);
            for (var j = 0; j < count; j++) {
                if (results[j] !== (data[j] * data[j])) {
                    testFailed("");
                    break;
                }
            }
        }
        testPassed("");
    } catch (e) {
        testFailed("WebCL: test all devices using a single context has failed. ; Message: "+ e.message);
    }
}
</script>

</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Test all devices available in one platform using a single context");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
