<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebCL create buffer stress test </title>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/webcl-test-utils.js"></script>

<script>

function getRandomSize(maxNumber)
{
    var x = Math.floor((Math.random() * maxNumber) + 1);
    return x;
}

function runTest()
{
    try {

        if (typeof(webcl) === "undefined") {
            testFailed("webcl is yet to be undefined");
            return null;
        }

        var cl = webcl;

        if (cl === null) {
            testFailed("Failed to create webcl object");
            return;
        }

        var platforms = cl.getPlatforms();
        if (platforms.length === 0) {
            testFailed("No platforms available");
            return;
        }
        var platform = platforms[0];

        var devices = platform.getDevices(cl.DEVICE_TYPE_GPU);
        var numDevices = devices.length;
        if (numDevices === 0) {
            testFailed("No devices available");
            return;
        }

        var device = devices[0];
        var contextProperties = {platform: platform, devices: devices, deviceType: cl.DEVICE_TYPE_GPU, hint: null};
        var context = cl.createContext(contextProperties);
        if (context === null) {
            testFailed("Context was not created");
            return;
        }

        var maxMemAllocSize = device.getInfo(cl.DEVICE_MAX_MEM_ALLOC_SIZE);
        var clBuffer = null;
        var bufferSize;

        for (var i = 0; i < STRESS_ITERS; i++) {
            num = getRandomSize(maxMemAllocSize);
            bufferSize = Int32Array.BYTES_PER_ELEMENT * num;
            clBuffer = context.createBuffer(cl.MEM_READ_ONLY, bufferSize);
            if (clBuffer === null) {
                testFailed("WebCLBuffer was not created properly. Buffer size (in bytes): " + bufferSize);
                return;
            }
            //TODO: Release the Memory Object
            clBuffer = null;
        }

        testPassed("");

        } catch (e) {
            testFailed("WebCLBuffer stress test failed ; Message: "+ e.message);
        }
}

</script>
</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Create several WebCLBuffer with different sizes. To pass, it should not crash.");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
