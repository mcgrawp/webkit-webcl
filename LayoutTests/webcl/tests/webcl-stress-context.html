<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>WebCL Create Context Stress Test</title>
<script src="../resources/js-test-pre.js"></script>
<script src="../resources/webcl-test.js"></script>
<script src="../resources/webcl-test-utils.js"></script>

<script>

/* Webkit is crashing when the number of iterations is greater than 20.000 and
 * getting time out when the iteration is greater than 10.000.
 * The backtrace is available at: http://pastebin.com/EChVqeLn
 */

function runTest() {
    var i;
    var wclt;
    var platform;
    var devices;
    var deviceType;
    var context;
    var contextProperties;
    var STRESS_ITERS_CONTEXT = 10000;

    try {
        wclt = WebCLTest;
        wclt.init(0, 0, "gpu");

        platform = wclt.getPlatform(0);
        devices = wclt.getDevices();
        deviceType = wclt.getDeviceType();
        contextProperties = { "platform": platform,
                                "devices": devices,
                                "deviceType": deviceType,
                                "shareGroup": 0,
                                "hints": null};

        for (i = 0; i < STRESS_ITERS_CONTEXT; i++) {
            context = wclt.createContext(contextProperties);
            if (!(context instanceof WebCLContext)) {
                testFailed("WebCLContext was not created properly.");
                return;
            }
            // TODO clean up when the release has been ok
        }
        testPassed("");

    } catch (e) {
        testFailed("WebCLContext stress test failed ; Message: " + e.message);
    }
}

</script>
</head>
<body>
<div id="description"></div>
<div id="console"></div>
<script>
    description("Create several WebCLContexts. To pass, it should not crash.");
    runTest();
</script>
<script src="../resources/js-test-post.js"></script>
</body>
</html>
